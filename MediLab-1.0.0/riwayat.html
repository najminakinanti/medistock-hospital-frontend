<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Riwayat</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <!-- Favicons -->
    <link href="assets/img/logomed.png" rel="icon">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

    <!-- Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet">
</head>

  <!-- Custom CSS -->
  <style>
    button.detail-button {
      background-color: #1977cc; 
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    button.detail-button:hover {
      background-color: #485e8c; 
    }

    #navmenu {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #fff;
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logout-btn {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }

    .logo {
      height: 30px;
      width: auto;
    }

    .table-wrapper {
      max-width: 800px;
      margin: 30px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
      font-family: Arial, sans-serif;
    }
            
    .table-wrapper table {
      width: 100%;              
      border-collapse: collapse;              
       min-width: 600px;
    }                                     
            
    .table-wrapper th,
    .table-wrapper td {                        
      border: 1px solid #ccc;              
      padding: 12px 16px;              
      text-align: center;              
    }            
            
    .table-wrapper th {            
      background-color: #e0e0e0;              
    }            
            
    .table-wrapper tr:nth-child(even) {
      background-color: #f9f9f9;
    }                                      
            
    .search-bar {
      margin-bottom: 15px;
      width: 100%;              
      display: flex;              
      justify-content: center;                            
    }

    .search-bar input {            
      width: 100%;              
      max-width: 500px;              
      padding: 8px 12px;              
      font-size: 16px;              
      border-radius: 5px;              
      border: 1px solid #ccc;              
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
      padding-top: 60px;
    }
            
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
    }
            
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
            
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>

<body class="index-page">
    <header id="header" class="header sticky-top">
    <div class="branding d-flex align-items-center">
        <div class="container position-relative d-flex align-items-center justify-content-between">
            <a href="beranda.html" class="logo d-flex align-items-center me-auto">
                <h1 class="sitename">MediStock</h1>
            </a>

            <!-- Navbar -->
            <nav id="navmenu" class="navmenu">
                <ul>
                    <li><a href="beranda.html" >Beranda</a></li>
                    <li><a href="inventaris.html">Inventaris</a></li>
                    <li><a href="riwayat.html" class="active">Riwayat</a></li>
                </ul>

                <div class="nav-right">
                    <a class="cta-btn d-none d-sm-block" href="bp.html">Buat Permintaan</a>
                      <button class="logout-btn" id="logoutBtn">
                        <img src="assets/img/logout.png" alt="Logo Logout" class="logo" />
                      </button>
                </div>

                <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
            </nav>
        </div>
    </div>
    </header>

    <main class="main">
        <section id="contact" class="contact section">
            <div class="container section-title" data-aos="fade-up">
                <h2>Riwayat</h2>
                <p>Lacak Barang yang Pernah Dipesan</p>
            </div>

            <div class="container mt-5" style="max-width: 800px;">
              <h2 class="mb-4">Daftar Permintaan Barang</h2>
            
              <!-- Search Bar -->
              <div class="mb-3">
                <input type="text" id="searchInput" class="form-control" placeholder="Cari tanggal atau nomor permintaan..."
                  onkeyup="searchTable()" />
              </div>
            
              <!-- Tabel Data -->
              <div class="table-responsive">
                <table class="table table-bordered table-striped" id="permintaanTable">
                  <thead class="table-dark">
                    <tr>
                      <th>No</th>
                      <th>Waktu Permintaan</th>
                      <th>Aksi</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody">
                  </tbody>
                </table>
              </div>
            </div>
          
            <!-- Modal -->
            <div id="detailModal" class="modal" style="display:none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow:auto; background-color: rgba(0,0,0,0.4);">
              <div class="modal-content" style="background:#fff; margin: 10% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px; position: relative;">
                <span class="close" onclick="closeModal()" style="position:absolute; top:10px; right:15px; font-size:28px; cursor:pointer;">&times;</span>
                  <h2>Rincian Permintaan</h2>
                    <div id="modalDetails"></div>
        </section>

        <div class="container copyright text-center mt-4">
            <p>Â© <span>Copyright</span> <strong class="px-1 sitename">MediStock</strong> <span>All Rights
                    Reserved</span></p>
            <div class="credits">
            </div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', function () {
              const logoutBtn = document.getElementById('logoutBtn');
              if (logoutBtn) {
                logoutBtn.addEventListener('click', function () {
                  const token = localStorage.getItem('token');

                  if (!token) {
                    window.location.href = 'login.html';
                    return;
                  }

                  fetch('http://127.0.0.1:8000/api/logout', {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Accept': 'application/json'
                    }
                  })
                    .then(response => {
                      localStorage.removeItem('token');
                      window.location.href = 'login.html';
                    })
                    .catch(error => {
                      console.error('Logout error:', error);
                      localStorage.removeItem('token');
                      window.location.href = 'login.html';
                    });
                });
              }
            });

          function searchTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
              const tdNo = rows[i].getElementsByTagName('td')[0];
              const tdTanggal = rows[i].getElementsByTagName('td')[1]; 
              if (tdNo && tdTanggal) {
                const textNo = tdNo.textContent.toLowerCase();
                const textTanggal = tdTanggal.textContent.toLowerCase();

                if (textNo.indexOf(filter) > -1 || textTanggal.indexOf(filter) > -1) {
                  rows[i].style.display = ''; 
                } else {
                  rows[i].style.display = 'none';  
                }
              }
            }
          }

          const apiUrl = "http://127.0.0.1:8000/api/orders";

          async function loadOrders() {
            console.log("Masuk ke fungsi loadOrders");

            const tableBody = document.getElementById('tableBody');
            const token = localStorage.getItem('token');

            if (!token) {
              tableBody.innerHTML = `<tr><td colspan="3">Data tidak ditemukan.</td></tr>`;
              console.warn('Token tidak ditemukan di localStorage');
              return;
            }

            try {
              const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                }
              });

              if (!response.ok) throw new Error('Gagal mengambil data permintaan: ' + response.status);

              const jsonResponse = await response.json();
              console.log('Respons API:', jsonResponse);

              const data = jsonResponse.data || jsonResponse;

              if (!Array.isArray(data)) {
                tableBody.innerHTML = `<tr><td colspan="3">Data tidak dalam format array</td></tr>`;
                return;
              }

              tableBody.innerHTML = '';

              data.forEach((order, index) => {
                const tr = document.createElement('tr');

                const tdNo = document.createElement('td');
                tdNo.textContent = index + 1;

                const tdTanggal = document.createElement('td');
                tdTanggal.textContent = order.order_date || '-';

                const tdAksi = document.createElement('td');
                const btnDetail = document.createElement('button');
                btnDetail.textContent = 'Lihat Detail';

                btnDetail.classList.add('detail-button');

                btnDetail.addEventListener('click', () => {
                  openModal(order);
                });

                tdAksi.appendChild(btnDetail);

                tr.appendChild(tdNo);
                tr.appendChild(tdTanggal);
                tr.appendChild(tdAksi);

                tableBody.appendChild(tr);
              });


            } catch (error) {
              console.error('Error saat loadOrders:', error);
              tableBody.innerHTML = `<tr><td colspan="3">Gagal memuat data: ${error.message}</td></tr>`;
            }
          }

          // Fungsi untuk membuka modal dan isi detail
          function openModal(order) {
              const modal = document.getElementById('detailModal');
              const modalDetails = document.getElementById('modalDetails');

              let itemsList = '';
              if (order.order_items && order.order_items.length > 0) {
                itemsList = '<ul>';
                order.order_items.forEach(oi => {
                  itemsList += `<li>${oi.item.name} - Jumlah: ${oi.quantity}</li>`;
                });
                itemsList += '</ul>';
              } else {
                itemsList = '<p>Tidak ada barang.</p>';
              }

              modalDetails.innerHTML = `
              <p><strong>ID Pesanan:</strong> ${order.id}</p>
              <p><strong>Tanggal Pesan:</strong> ${order.order_date || '-'}</p>
              <p><strong>Status:</strong> ${order.status || '-'}</p>
              <p><strong>Jumlah Barang:</strong> ${order.order_items ? order.order_items.length : 0}</p>
              <p><strong>Nama Barang:</strong></p>
              ${itemsList}
            `;

              modal.style.display = 'block';
            }

          // Fungsi menutup modal
          function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
          }

          // Tutup modal kalau klik di luar content modal
          window.onclick = function (event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
              closeModal();
            }
          }

          window.addEventListener('DOMContentLoaded', () => {
            console.log("Event DOMContentLoaded dijalankan");
            loadOrders();
          });
        </script>

        <!-- Scroll Top -->
        <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
                class="bi bi-arrow-up-short"></i></a>

        <!-- Preloader -->
        <div id="preloader"></div>

        <!-- Vendor JS Files -->
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/vendor/php-email-form/validate.js"></script>
        <script src="assets/vendor/aos/aos.js"></script>
        <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
        <script src="assets/vendor/purecounter/purecounter_vanilla.js"></script>
        <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

        <!-- Main JS File -->
        <script src="assets/js/main.js"></script>

</body>

</html>